#!/bin/bash
set -e

HOSTS=/etc/hosts
UNLOCK_FILE=/var/lib/piko/unlock_at
DOMAINS_FILE=/var/lib/piko/domains

# Check for help flags early (before sudo)
if [ "${1:-}" = "-h" ] || [ "${1:-}" = "--help" ] || [ "${1:-}" = "-l" ] || [ "${1:-}" = "--list" ]; then
    SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
    source "${SCRIPT_DIR}/piko-lib"
    
    if [ "${1:-}" = "-l" ] || [ "${1:-}" = "--list" ]; then
        list_presets
        exit 0
    fi
    
    cat <<EOF
Usage: piko-block <minutes> [options] [domains...]

Block websites for a focused work session.

Arguments:
  minutes           Duration in minutes (required)
  domains           Additional domains to block (optional)

Options:
  -p, --preset NAME Use preset blocklist (can be repeated)
  -l, --list        List available presets and exit
  -h, --help        Show this help

Presets:
  social        Instagram, Twitter, Facebook, TikTok, Reddit, LinkedIn
  news          CNN, BBC, Hacker News, NYTimes, The Guardian
  entertainment YouTube, Netflix, Twitch, Hulu, Disney+
  shopping      Amazon, eBay, Etsy
  work          Reddit, Twitter, Hacker News

Examples:
  piko-block 60 instagram.com youtube.com
  piko-block --preset social
  piko-block -p social -p news 90

EOF
    exit 0
fi

parse_args() {
    PRESETS=()
    DOMAINS=()
    MINUTES=""
    
    while [ $# -gt 0 ]; do
        case "$1" in
            -p|--preset)
                PRESETS+=("$2")
                shift 2
                ;;
            *)
                if [ -z "$MINUTES" ] && [[ "$1" =~ ^[0-9]+$ ]]; then
                    MINUTES="$1"
                else
                    DOMAINS+=("$1")
                fi
                shift
                ;;
        esac
    done
    
    if [ -z "$MINUTES" ]; then
        load_config
        MINUTES=$(get_default_duration)
    fi
    
    if [ -z "$MINUTES" ]; then
        echo "Error: duration required. Use -h for help." >&2
        exit 1
    fi
}

add_domains_from_preset() {
    local preset="$1"
    local domains
    domains=$(get_preset_domains "$preset")
    
    if [ -z "$domains" ]; then
        echo "Error: unknown preset '$preset'. Use --list to see available presets." >&2
        exit 1
    fi
    
    IFS=',' read -ra ADDR <<< "$domains"
    for d in "${ADDR[@]}"; do
        d=$(echo "$d" | xargs)  # trim whitespace
        if [ -n "$d" ]; then
            DOMAINS+=("$d")
        fi
    done
}

[ "$EUID" -ne 0 ] && exec sudo "$0" "$@"

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
source "${SCRIPT_DIR}/piko-lib"

parse_args "$@"

if [ -z "$MINUTES" ]; then
    echo "Error: minutes required. Use -h for help." >&2
    exit 1
fi

if ! [[ "$MINUTES" =~ ^[0-9]+$ ]] || [ "$MINUTES" -le 0 ]; then
    echo "Error: minutes must be a positive integer. Use -h for help." >&2
    exit 1
fi

for preset in "${PRESETS[@]}"; do
    add_domains_from_preset "$preset"
done

if [ ${#DOMAINS[@]} -eq 0 ]; then
    echo "Error: no domains to block. Specify domains or use --preset. Use -h for help." >&2
    exit 1
fi

mkdir -p /var/lib/piko

chattr -i "$HOSTS" 2>/dev/null || true

touch "$DOMAINS_FILE"

for domain in "${DOMAINS[@]}"; do
    domain=${domain,,}
    domain=${domain#http://}
    domain=${domain#https://}
    domain=${domain%%/*}
    domain=${domain#www.}

    [ -z "$domain" ] && continue

    if ! grep -qx "$domain" "$DOMAINS_FILE" 2>/dev/null; then
        printf '%s\n' "$domain" >> "$DOMAINS_FILE"
    fi

    grep -q "# piko:${domain}:ipv4" "$HOSTS" || \
        echo "127.0.0.1 $domain www.$domain # piko:${domain}:ipv4" >> "$HOSTS"
    grep -q "# piko:${domain}:ipv6" "$HOSTS" || \
        echo "::1 $domain www.$domain # piko:${domain}:ipv6" >> "$HOSTS"
done

date -d "+${MINUTES} minutes" +%s > "$UNLOCK_FILE"

chattr +i "$HOSTS"

/usr/local/bin/piko-browser-guard apply 2>/dev/null || true
/usr/local/bin/piko-browser-cycle lock 2>/dev/null || true

systemctl try-restart systemd-resolved 2>/dev/null || true

echo "Blocked ${DOMAINS[*]} for ${MINUTES}m - unlocks at $(date -d @$(cat "$UNLOCK_FILE"))"
echo "Browser policy guard applied; open browsers were cycled for enforcement."
