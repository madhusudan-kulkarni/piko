#!/bin/bash
set -euo pipefail

STATE_DIR=/var/lib/piko
LAST_UNLOCK_FILE="$STATE_DIR/last_unlock_at"

usage() {
    echo "Usage: piko-browser-cycle <lock|unlock>"
}

browser_names=(
    firefox
    firefox-bin
    google-chrome
    google-chrome-stable
    chromium
    chromium-browser
)

if [ "${EUID}" -ne 0 ]; then
    exec sudo "$0" "$@"
fi

[ "$#" -eq 1 ] || { usage; exit 1; }
MODE=$1
case "$MODE" in
    lock|unlock) ;;
    *) usage; exit 1 ;;
esac

collect_pids() {
    for name in "${browser_names[@]}"; do
        pgrep -x "$name" 2>/dev/null || true
    done | sort -u
}

PIDS=$(collect_pids)
if [ -z "$PIDS" ]; then
    if [ "$MODE" = "unlock" ]; then
        mkdir -p "$STATE_DIR"
        date +%s > "$LAST_UNLOCK_FILE"
    fi
    exit 0
fi

logger "Piko: browser cycle($MODE) started"

while IFS= read -r pid; do
    [ -z "$pid" ] && continue
    kill -TERM "$pid" 2>/dev/null || true
done <<< "$PIDS"

for _ in 1 2 3 4 5 6 7 8; do
    sleep 1
    REMAINING=""
    while IFS= read -r pid; do
        [ -z "$pid" ] && continue
        if kill -0 "$pid" 2>/dev/null; then
            REMAINING+="$pid "$'\n'
        fi
    done <<< "$PIDS"

    if [ -z "$REMAINING" ]; then
        logger "Piko: browser cycle($MODE) graceful close complete"
        if [ "$MODE" = "unlock" ]; then
            mkdir -p "$STATE_DIR"
            date +%s > "$LAST_UNLOCK_FILE"
        fi
        exit 0
    fi
done

while IFS= read -r pid; do
    [ -z "$pid" ] && continue
    kill -KILL "$pid" 2>/dev/null || true
done <<< "$PIDS"

logger "Piko: browser cycle($MODE) force close applied"

if [ "$MODE" = "unlock" ]; then
    mkdir -p "$STATE_DIR"
    date +%s > "$LAST_UNLOCK_FILE"
fi
